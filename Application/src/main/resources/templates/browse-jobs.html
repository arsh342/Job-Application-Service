<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browse Jobs - Skillfind</title>
    <script src="/static/js/pre-auth.js"></script>
    <script src="/static/js/auth-helper.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      body {
        background: #f5f7fa;
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }

      .layout {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 280px;
        background: white;
        border-right: 1px solid #e5e9f2;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        z-index: 1000;
      }

      .sidebar-header {
        padding: 24px;
        border-bottom: 1px solid #e5e9f2;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
      }

      .logo-icon {
        width: 50px;
        height: 50px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 24px;
        border-bottom: 1px solid #e5e9f2;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #b7d7f9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      .user-details h4 {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
      }

      .user-details p {
        font-size: 12px;
        color: #6b7280;
      }

      .nav-menu {
        padding: 16px 0;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        color: #6b7280;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 14px;
      }

      .nav-item:hover {
        background: #f8fafc;
        color: #374151;
      }

      .nav-item.active {
        background: #f0f9ff;
        color: #667eea;
        border-left: 4px solid #667eea;
        border-bottom-right-radius: 20px;
        border-top-right-radius: 20px;
      }

      .nav-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 280px;
        padding: 32px;
      }

      .page-header {
        margin-bottom: 32px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .page-subtitle {
        font-size: 16px;
        color: #6b7280;
      }

      .container {
        max-width: none;
        margin: 0;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e9f2;
        overflow: hidden;
        padding: 20px;
      }

      .header h1 {
        font-size: 1.75rem;
        font-weight: 600;
      }

      .header-buttons {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background-color 0.15s ease-in-out;
        text-decoration: none;
        display: inline-block;
        font-weight: 500;
      }

      .btn-primary {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 20px;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
      }

      .search-filters {
        background: white;
        padding: 32px;
        border-radius: 16px;
        border: 1px solid #e5e9f2;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .filter-group {
        display: inline-block;
        margin-right: 24px;
        margin-bottom: 16px;
      }

      .filter-group label {
        display: block;
        margin-bottom: 8px;
        color: #374151;
        font-weight: 600;
        font-size: 14px;
      }

      input,
      select {
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 50px;
        font-size: 14px;
        transition: all 0.2s ease;
        background-color: white;
        min-width: 160px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .job-card {
        background: white;
        border: 1px solid #e5e9f2;
        padding: 32px;
        margin-top: 10px;
        border-bottom: 1px solid #e5e9f2;
        transition: all 0.2s ease;
        border-radius: 16px;
      }

      .job-card:hover {
        background: #f8fafc;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .job-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
      }

      .job-title {
        margin: 0 0 8px 0;
        color: #1f2937;
        font-size: 20px;
        font-weight: 700;
      }

      .job-company {
        color: #6b7280;
        margin-bottom: 12px;
        font-weight: 500;
        font-size: 14px;
      }

      .job-details {
        margin: 20px 0;
        line-height: 1.6;
      }

      .job-details p {
        margin: 8px 0;
        color: #6b7280;
        font-size: 14px;
      }

      .job-actions {
        margin-top: 24px;
        display: flex;
        gap: 12px;
      }

      .apply-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        font-size: 14px;
      }

      .apply-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
      }

      .view-details-btn {
        background: #667eea;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        font-size: 14px;
        margin-right: 8px;
      }

      .view-details-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
      }

      .view-btn {
        background: #667eea;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        font-size: 14px;
      }

      .view-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
      }

      .applied-badge {
        background: #fff3cd;
        color: #856404;
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 20px;
        font-weight: 500;
        text-transform: uppercase;
        border: 1px solid #ffeaa7;
      }

      .salary {
        font-weight: 600;
        color: #28a745;
        font-size: 1.1rem;
      }

      .location {
        color: #6c757d;
        font-weight: 500;
      }

      .posted-date {
        color: #adb5bd;
        font-size: 0.9rem;
      }

      .no-jobs {
        text-align: center;
        color: #666;
        padding: 60px 30px;
        font-size: 1.1rem;
      }

      .pagination {
        text-align: center;
        margin-top: 30px;
        padding: 30px;
        background: #f8f9fa;
        border-top: 1px solid #e1e1e1;
      }

      .pagination button {
        margin: 0 5px;
        padding: 8px 16px;
        background: white;
        border: 2px solid #667eea;
        color: #667eea;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .pagination button:hover {
        background: #667eea;
        color: white;
      }

      .pagination button.active {
        background: #667eea;
        color: white;
      }

      .content-area {
        min-height: 400px;
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <!-- Include shared sidebar -->
      <div th:replace="shared/sidebar :: sidebar"></div>

      <div class="main-content">
        <div class="page-header">
          <h1 class="page-title">Browse Jobs</h1>
          <p class="page-subtitle">Discover your next career opportunity</p>
        </div>

        <div class="content-area">
          <!-- Search and Filter Section -->
          <div class="search-filters">
          <div class="filter-group">
            <label>Search:</label>
            <input
              type="text"
              id="searchInput"
              placeholder="Job title, company, or keywords..."
              onkeyup="filterJobs()"
              disabled
            />
          </div>
          <div class="filter-group">
            <label>Location:</label>
            <input
              type="text"
              id="locationFilter"
              placeholder="City or state..."
              onkeyup="filterJobs()"
              disabled
            />
          </div>
          <div class="filter-group">
            <label>Salary Range:</label>
            <select id="salaryFilter" onchange="filterJobs()" disabled>
              <option value="">Any</option>
              <option value="0-30000">₹0 - ₹30,000</option>
              <option value="30000-50000">₹30,000 - ₹50,000</option>
              <option value="50000-75000">₹50,000 - ₹75,000</option>
              <option value="75000-100000">₹75,000 - ₹100,000</option>
              <option value="100000+">₹100,000+</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Sort By:</label>
            <select id="sortBy" onchange="filterJobs()" disabled>
              <option value="newest">Newest</option>
              <option value="oldest">Oldest</option>
              <option value="salary_high">Salary High to Low</option>
              <option value="salary_low">Salary Low to High</option>
            </select>
          </div>
          <div class="filter-group">
            <button class="btn btn-primary" onclick="clearFilters()">
              Clear All
            </button>
          </div>
        </div>

        <!-- Jobs List Section -->
        <div id="jobsList">
          <!-- Jobs will be dynamically loaded here -->
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <div id="paginationControls">
            <!-- Pagination controls will be generated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Include shared sidebar script -->
    <div th:replace="shared/sidebar :: sidebar-script"></div>

    <script>
      let allJobs = [];
      let filteredJobs = [];
      let appliedJobs = new Set();
      let currentPage = 1;
      let jobsPerPage = 10;

      // JWT utility functions
      function getJwtToken() {
        return (
          localStorage.getItem("authToken") ||
          localStorage.getItem("jwtToken") ||
          sessionStorage.getItem("authToken")
        );
      }

      function setJwtToken(token, userData) {
        // Remove previous user data
        localStorage.removeItem("authToken");
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("userName");
        localStorage.removeItem("userEmail");
        localStorage.removeItem("userId");
        sessionStorage.removeItem("authToken");

        // Set new token and user data
        localStorage.setItem("authToken", token);
        localStorage.setItem("jwtToken", token); // Keep for compatibility
        if (userData) {
          localStorage.setItem("userName", userData.name);
          localStorage.setItem("userEmail", userData.email);
          localStorage.setItem("userId", userData.userId.toString());
        }
      }

      function removeJwtToken() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("jwtToken");
        sessionStorage.removeItem("authToken");
      }

      function getAuthHeaders() {
        const token = getJwtToken();
        return token ? { Authorization: `Bearer ${token}` } : {};
      }

      function navigateToPage(page) {
        const token = getJwtToken();
        if (token) {
          window.location.href = `${page}?token=${encodeURIComponent(token)}`;
        } else {
          window.location.href = page;
        }
      }

      window.addEventListener("load", async function () {
        // Check for token in URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get("token");
        if (urlToken) {
          localStorage.setItem("authToken", urlToken);
          localStorage.setItem("jwtToken", urlToken);
          // Clean URL by removing token parameter
          const cleanUrl = new URL(window.location);
          cleanUrl.searchParams.delete("token");
          window.history.replaceState({}, document.title, cleanUrl);

          // Fetch fresh profile and update sidebar/localStorage
          try {
            const resp = await fetch("http://localhost:8083/api/auth/validate", {
              method: "POST",
              headers: { Authorization: `Bearer ${urlToken}` },
            });
            if (resp.ok) {
              const data = await resp.json();
              if (data && data.valid) {
                if (data.name) localStorage.setItem("userName", data.name);
                if (data.email) localStorage.setItem("userEmail", data.email);
                if (data.userId) localStorage.setItem("userId", String(data.userId));
                // Update sidebar DOM if present
                const nameEl = document.getElementById("userName");
                const emailEl = document.getElementById("userEmail");
                const avatarEl = document.getElementById("userAvatar");
                if (nameEl && data.name) nameEl.textContent = data.name;
                if (emailEl && data.email) emailEl.textContent = data.email;
                if (avatarEl && data.name) avatarEl.textContent = String(data.name).charAt(0).toUpperCase();
              }
            }
          } catch (e) {}
        }

        // Give AuthHelper more time to process URL tokens before checking auth
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // Check authentication before loading content
        checkAuth();
        
        // Load jobs and applications
        await loadJobs();
        await loadAppliedJobs();
      });

      async function loadJobs() {
        try {
          const response = await fetch("http://localhost:8081/api/jobs/all", {
            headers: getAuthHeaders()
          });

          if (response.ok) {
            allJobs = await response.json();
            // Filter only open jobs
            allJobs = allJobs.filter((job) => job.status === "OPEN");
            filteredJobs = [...allJobs];
            displayJobs();
          } else {
            document.getElementById("jobsList").innerHTML =
              '<div class="no-jobs">Failed to load jobs</div>';
          }
        } catch (error) {
          console.error("Error loading jobs:", error);
          document.getElementById("jobsList").innerHTML =
            '<div class="no-jobs">Error loading jobs</div>';
        }
      }

      async function loadAppliedJobs() {
        try {
          const response = await fetch("/api/applications/my-applications", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            },
          });
          if (response.ok) {
            const applications = await response.json();
            appliedJobs = new Set(applications.map((app) => app.jobId));
            displayJobs(); // Refresh display to show applied status
          }
        } catch (error) {
          console.error("Error loading applied jobs:", error);
        }
      }

      function displayJobs() {
        const jobsList = document.getElementById("jobsList");

        if (filteredJobs.length === 0) {
          jobsList.innerHTML =
            '<div class="no-jobs">No jobs found matching your criteria</div>';
          return;
        }

        // Calculate pagination
        const startIndex = (currentPage - 1) * jobsPerPage;
        const endIndex = startIndex + jobsPerPage;
        const jobsToShow = filteredJobs.slice(startIndex, endIndex);

        jobsList.innerHTML = jobsToShow
          .map((job) => {
            const isApplied = appliedJobs.has(job.jobId);
            return `
                    <div class="job-card">
                        <div class="job-header">
                            <div style="flex: 1;">
                                <h3 class="job-title">${job.title}</h3>
                                <div class="job-company">${job.company}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="posted-date">Posted: ${job.postedDate}</div>
                            </div>
                        </div>
                        
                        <div class="job-details">
                            <p><span class="location"> ${
                              job.location
                            }</span></p>
                            ${
                              job.salaryMin || job.salaryMax
                                ? `<p class="salary"> ${
                                    job.salaryMin && job.salaryMax
                                      ? `₹${job.salaryMin} - ₹${job.salaryMax}`
                                      : job.salaryMin
                                      ? `₹${job.salaryMin}+`
                                      : `Up to ₹${job.salaryMax}`
                                  }</p>`
                                : '<p class="salary"> Not specified</p>'
                            }
                            <p>${
                              job.description.length > 200
                                ? job.description.substring(0, 200) + "..."
                                : job.description
                            }</p>
                        </div>
                        
                        <div class="job-actions">
                            <button onclick="viewJobDetails(${job.jobId})" class="view-details-btn">View Details</button>
                            ${
                              !isApplied
                                ? `<button onclick="applyNow(${job.jobId})" class="apply-btn">Apply Now</button>`
                                : `<button class="btn btn-primary" style="background: #059669; cursor: default;" disabled>Applied</button>`
                            }
                        </div>
                    </div>
                `;
          })
          .join("");

        // Enable filter inputs/selects after jobs are loaded
        document.getElementById("searchInput").disabled = false;
        document.getElementById("locationFilter").disabled = false;
        document.getElementById("salaryFilter").disabled = false;
        document.getElementById("sortBy").disabled = false;

        displayPagination();
      }

      function displayPagination() {
        const totalPages = Math.ceil(filteredJobs.length / jobsPerPage);
        const pagination = document.getElementById("paginationControls");

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        let paginationHTML = "";

        // Previous button
        if (currentPage > 1) {
          paginationHTML += `<button onclick="changePage(${
            currentPage - 1
          })">Previous</button>`;
        }

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (i === currentPage) {
            paginationHTML += `<button style="background-color: #4CAF50; color: white;">${i}</button>`;
          } else {
            paginationHTML += `<button onclick="changePage(${i})">${i}</button>`;
          }
        }

        // Next button
        if (currentPage < totalPages) {
          paginationHTML += `<button onclick="changePage(${
            currentPage + 1
          })">Next</button>`;
        }

        pagination.innerHTML = paginationHTML;
      }

      function changePage(page) {
        currentPage = page;
        displayJobs();
      }

      function filterJobs() {
        const searchValue = document.getElementById("searchInput").value.toLowerCase();
        const locationValue = document.getElementById("locationFilter").value.toLowerCase();
        const salaryValue = document.getElementById("salaryFilter").value;
        const sortBy = document.getElementById("sortBy") ? document.getElementById("sortBy").value : "newest";

        filteredJobs = allJobs.filter((job) => {
          let matches =
            (job.title.toLowerCase().includes(searchValue) ||
              (job.companyName && job.companyName.toLowerCase().includes(searchValue)) ||
              (job.company && job.company.toLowerCase().includes(searchValue)) ||
              (job.keywords && job.keywords.toLowerCase().includes(searchValue))) &&
            job.location.toLowerCase().includes(locationValue);

          // Salary filter using salaryMin and salaryMax
          if (salaryValue) {
            const min = job.salaryMin || 0;
            const max = job.salaryMax || 0;
            switch (salaryValue) {
              case "0-30000":
                if (!((min <= 30000 && min >= 0) || (max <= 30000 && max > 0))) matches = false;
                break;
              case "30000-50000":
                if (!((min > 30000 && min <= 50000) || (max > 30000 && max <= 50000))) matches = false;
                break;
              case "50000-75000":
                if (!((min > 50000 && min <= 75000) || (max > 50000 && max <= 75000))) matches = false;
                break;
              case "75000-100000":
                if (!((min > 75000 && min <= 100000) || (max > 75000 && max <= 100000))) matches = false;
                break;
              case "100000+":
                if (!(min > 100000 || max > 100000)) matches = false;
                break;
            }
          }
          return matches;
        });

        // Sort jobs
        filteredJobs.sort((a, b) => {
          switch (sortBy) {
            case "newest":
              return new Date(b.postedDate) - new Date(a.postedDate);
            case "oldest":
              return new Date(a.postedDate) - new Date(b.postedDate);
            case "salary_high":
              return (b.salaryMax || b.salaryMin || 0) - (a.salaryMax || a.salaryMin || 0);
            case "salary_low":
              return (a.salaryMin || a.salaryMax || 0) - (b.salaryMin || b.salaryMax || 0);
            default:
              return 0;
          }
        });

        currentPage = 1;
        displayJobs();
      }

      function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("locationFilter").value = "";
        document.getElementById("salaryFilter").value = "";
        document.getElementById("sortBy").value = "newest";
        filterJobs();
      }

      function viewJobDetails(jobId) {
        // Navigate to job details page with authentication token in the same tab
        const token = getJwtToken();
        if (token) {
          window.location.href = `/job-details?id=${jobId}&token=${encodeURIComponent(token)}`;
        } else {
          alert("Please log in to view job details");
          window.location.href = "http://localhost:8083/login";
        }
      }

      function applyNow(jobId) {
        // Direct application logic here
        const job = allJobs.find((job) => job.jobId === jobId);

        if (!job) {
          alert("Job not found");
          return;
        }

        const applicationData = {
          jobId: job.jobId,
        };

        // Submit application
        fetch("/api/applications/apply", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...getAuthHeaders(),
          },
          body: JSON.stringify(applicationData),
        })
          .then((response) => {
            if (response.ok) {
              alert("Application submitted successfully!");
              appliedJobs.add(job.jobId);
              displayJobs();
            } else {
              response.text().then((text) => {
                alert("Failed to submit application: " + text);
              });
            }
          })
          .catch((error) => {
            alert("Error submitting application: " + error.message);
          });
      }

      async function logout() {
        removeJwtToken();
        window.location.href = "/login";
      }
    </script>
  </body>
</html>
