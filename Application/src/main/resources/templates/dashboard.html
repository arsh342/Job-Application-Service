<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skillfind - Job Seeker Dashboard</title>
    <script src="/static/js/pre-auth.js"></script>
    <script src="/static/js/auth-helper.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      body {
        background: #f5f7fa;
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }

      .layout {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 280px;
        background: white;
        border-right: 1px solid #e5e9f2;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        z-index: 1000;
      }

      .sidebar-header {
        padding: 24px;
        border-bottom: 1px solid #e5e9f2;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
      }

      .logo-icon {
        width: 50px;
        height: 50px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 24px;
        border-bottom: 1px solid #e5e9f2;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      .user-details h4 {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
      }

      .user-details p {
        font-size: 12px;
        color: #6b7280;
      }

      .nav-menu {
        padding: 16px 0;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        color: #6b7280;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 14px;
      }

      .nav-item:hover {
        background: #f8fafc;
        color: #374151;
      }

      .nav-item.active {
        background: #f0f9ff;
        color: #0ea5e9;
        border-right: 3px solid #0ea5e9;
      }

      .nav-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 280px;
        padding: 32px;
      }

      .page-header {
        margin-bottom: 32px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .page-subtitle {
        font-size: 16px;
        color: #6b7280;
      }

      .header h1 {
        font-size: 1.75rem;
        font-weight: 600;
      }

      .header-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background-color 0.15s ease-in-out;
        text-decoration: none;
        display: inline-block;
        font-weight: 500;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      /* Application Stats Overview */
      .stats-overview {
        margin-bottom: 32px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: white;
        border: 1px solid #e5e9f2;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-pending .stat-number {
        color: #1976d2;
      }

      .stat-shortlisted .stat-number {
        color: #f57c00;
      }

      .stat-hired .stat-number {
        color: #388e3c;
      }

      .stat-rejected .stat-number {
        color: #d32f2f;
      }

      .stat-pending {
        border-left: 4px solid #1976d2;
      }

      .stat-shortlisted {
        border-left: 4px solid #f57c00;
      }

      .stat-hired {
        border-left: 4px solid #388e3c;
      }

      .stat-rejected {
        border-left: 4px solid #d32f2f;
      }

      .dashboard-layout {
        display: flex;
        gap: 30px;
        padding: 30px;
      }

      .dashboard-layout .main-content {
        flex: 2;
        min-width: 0; /* Prevent flex item from overflowing */
      }

      .dashboard-layout .sidebar {
        flex: 1;
        min-width: 300px;
        max-width: 400px;
      }

      .section {
        margin-bottom: 30px;
        padding: 25px;
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e9f2;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .section h2 {
        color: #1f2937;
        margin-bottom: 20px;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Job recommendations styling */
      .jobs-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      /* Applications list styling */
      .applications-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .job-item {
        background: #f8fafc;
        margin: 0;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e5e9f2;
        transition: all 0.2s ease;
      }

      .job-item:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .job-item h3 {
        color: #1f2937;
        margin-bottom: 8px;
        font-size: 1.125rem;
        font-weight: 600;
      }

      .job-item p {
        color: #6b7280;
        margin: 4px 0;
        line-height: 1.5;
        font-size: 0.875rem;
      }

      .job-item .company {
        color: #3b82f6;
        font-weight: 500;
      }

      .job-item .location {
        color: #6b7280;
        font-size: 0.8rem;
      }

      .job-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 0.75rem;
      }

      .btn-outline {
        background: transparent;
        color: #6b7280;
        border: 1px solid #d1d5db;
      }

      .btn-outline:hover {
        background: #f3f4f6;
        color: #374151;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .dashboard-layout {
          flex-direction: column;
          gap: 20px;
          padding: 20px;
        }

        .dashboard-layout .sidebar {
          min-width: auto;
          max-width: none;
        }
      }

      .application-item {
        background: #f8fafc;
        margin: 0;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e5e9f2;
        transition: all 0.2s ease;
        position: relative;
      }

      .application-item:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
      }

      .application-item h4 {
        color: #1f2937;
        margin-bottom: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        line-height: 1.3;
      }

      .application-item p {
        color: #6b7280;
        margin: 4px 0;
        line-height: 1.4;
        font-size: 0.8rem;
      }

      .application-item .company {
        color: #3b82f6;
        font-weight: 500;
        font-size: 0.85rem;
      }

      .application-status {
        position: absolute;
        top: 12px;
        right: 12px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-applied {
        background: #dbeafe;
        color: #1976d2;
      }

      .status-shortlisted {
        background: #fff3cd;
        color: #f57c00;
      }

      .status-hired {
        background: #d4edda;
        color: #388e3c;
      }

      .status-rejected {
        background: #f8d7da;
        color: #d32f2f;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
      }

      .status-applied {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .status-shortlisted {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status-rejected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status-hired {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      #welcomeMessage {
        color: white;
        font-weight: 500;
        margin-right: 15px;
      }

      .quick-actions {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }

      .quick-action-btn {
        padding: 12px 20px;
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s;
      }

      .quick-action-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
      }

      .no-items {
        text-align: center;
        color: #666;
        padding: 40px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <!-- Include shared sidebar -->
      <div th:replace="shared/sidebar :: sidebar"></div>

      <div class="main-content">
        <div class="page-header">
          <h1 class="page-title">Dashboard</h1>
          <p class="page-subtitle">Welcome! Find your next opportunity</p>
        </div>

        <!-- Application Status Overview -->
        <div class="stats-overview">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalApplications">0</div>
              <div class="stat-label">Total Applications</div>
            </div>
            <div class="stat-card stat-pending">
              <div class="stat-number" id="pendingApplications">0</div>
              <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card stat-shortlisted">
              <div class="stat-number" id="shortlistedApplications">0</div>
              <div class="stat-label">Shortlisted</div>
            </div>
            <div class="stat-card stat-hired">
              <div class="stat-number" id="hiredApplications">0</div>
              <div class="stat-label">Hired</div>
            </div>
            <div class="stat-card stat-rejected">
              <div class="stat-number" id="rejectedApplications">0</div>
              <div class="stat-label">Rejected</div>
            </div>
          </div>
        </div>
        <!-- Job Recommendations Section -->
        <div class="section">
          <h2>üéØ Job Recommendations</h2>
          <div id="jobsList" class="jobs-list">
            <p class="no-items">No job recommendations available.</p>
          </div>
        </div>

        <!-- <div class="sidebar">
            <div class="section">
              <h2>üìã My Applications</h2>
              <div id="applicationsList" class="applications-list">
                <p class="no-items">No applications yet.</p>
              </div>
            </div>
          </div> -->

        <script>
          let currentApplicantId = null;
          let currentApplicant = null;

          // JWT utility functions (additional to sidebar)
          function setJwtToken(token) {
            localStorage.setItem("authToken", token);
            localStorage.setItem("jwtToken", token); // Keep for compatibility
          }

          function getAuthHeaders() {
            const token = getJwtToken();
            return token ? { Authorization: `Bearer ${token}` } : {};
          }
        </script>
        <div th:replace="shared/sidebar :: sidebar-script"></div>
        <script>
          // Check authentication on page load
          async function checkAuth() {
            // First check if token is passed via URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get("token");

            if (urlToken) {
              // Store token from URL parameter
              setJwtToken(urlToken);
              // Clean URL by removing token parameter
              window.history.replaceState(
                {},
                document.title,
                window.location.pathname
              );
            }

            const token = getJwtToken();
            if (!token) {
              window.location.href = "http://localhost:8083/login";
              return;
            }

            const userEmail = localStorage.getItem("userEmail");
            const userName = localStorage.getItem("userName");
            const userId = localStorage.getItem("userId");

            if (userEmail && userName && userId) {
              // Use stored user information
              currentApplicant = {
                id: parseInt(userId),
                name: userName,
                email: userEmail,
              };
              currentApplicantId = parseInt(userId);

              document.getElementById("userName").textContent = userName;
              document.getElementById("userEmail").textContent = userEmail;
              document.getElementById("userAvatar").textContent = userName
                .charAt(0)
                .toUpperCase();

              await loadJobs();
              await loadApplications();
              return;
            }

            // Fallback: try to get user info from Authentication Service
            try {
              const response = await fetch(
                "http://localhost:8083/api/auth/validate",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    ...getAuthHeaders(),
                  },
                }
              );

              if (!response.ok) {
                throw new Error("Authentication failed");
              }

              const userData = await response.json();
              if (userData.valid) {
                currentApplicant = {
                  id: userData.userId,
                  name: userData.name,
                  email: userData.email,
                };
                currentApplicantId = userData.userId;

                // Store user info for future use (always update to latest)
                if (
                  localStorage.getItem("userName") !== userData.name ||
                  localStorage.getItem("userEmail") !== userData.email ||
                  localStorage.getItem("userId") !== userData.userId.toString()
                ) {
                  localStorage.setItem("userName", userData.name);
                  localStorage.setItem("userEmail", userData.email);
                  localStorage.setItem("userId", userData.userId.toString());
                }

                document.getElementById("userName").textContent = userData.name;
                document.getElementById("userEmail").textContent =
                  userData.email;
                document.getElementById("userAvatar").textContent =
                  userData.name.charAt(0).toUpperCase();

                await loadJobs();
                await loadApplications();
              } else {
                throw new Error("Invalid token");
              }
            } catch (error) {
              console.error("Authentication error:", error);
              window.location.href = "http://localhost:8083/login";
            }
          }

          async function loadJobs() {
            try {
              const response = await fetch("http://localhost:8081/api/jobs", {
                headers: {
                  "Content-Type": "application/json",
                  ...getAuthHeaders(),
                },
              });
              if (response.ok) {
                const jobs = await response.json();
                displayJobs(jobs);
              }
            } catch (error) {
              console.error("Failed to load jobs:", error);
            }
          }

          async function searchJobs() {
            const title = document.getElementById("searchTitle").value;
            const location = document.getElementById("searchLocation").value;
            const companyName = document.getElementById("searchCompany").value;

            const params = new URLSearchParams();
            if (title) params.append("title", title);
            if (location) params.append("location", location);
            if (companyName) params.append("companyName", companyName);

            try {
              const response = await fetch(
                `http://localhost:8081/api/jobs?${params}`
              );
              if (response.ok) {
                const jobs = await response.json();
                displayJobs(jobs);
              }
            } catch (error) {
              console.error("Failed to search jobs:", error);
            }
          }

          function displayJobs(jobs) {
            const jobsList = document.getElementById("jobsList");
            jobsList.innerHTML = "";

            if (jobs.length === 0) {
              jobsList.innerHTML =
                '<p class="no-items">No job recommendations available.</p>';
              return;
            }

            jobs.forEach((job) => {
              const jobDiv = document.createElement("div");
              jobDiv.className = "job-item";
              jobDiv.innerHTML = `
                <h3>${job.title}</h3>
                <p class="company">${job.company}</p>
                <p class="location">üìç ${job.location}</p>
                <p class="description">${truncateText(job.description, 120)}</p>
                <p class="salary">üí∞ ${formatSalary(
                  job.salaryMin,
                  job.salaryMax
                )}</p>
                <p class="posted">üïê Posted ${formatDate(job.postedDate)}</p>
                <div class="job-actions">
                  <button class="btn btn-secondary" onclick="viewJobDetails(${
                    job.jobId
                  })">View Details</button>
                </div>
              `;
              jobsList.appendChild(jobDiv);
            });
          }

          function truncateText(text, maxLength) {
            if (!text) return "No description available";
            return text.length > maxLength
              ? text.substring(0, maxLength) + "..."
              : text;
          }

          function formatSalary(salaryMin, salaryMax) {
            if (salaryMin && salaryMax) {
              return `‚Çπ${salaryMin.toLocaleString()} - ‚Çπ${salaryMax.toLocaleString()}`;
            } else if (salaryMin) {
              return `‚Çπ${salaryMin.toLocaleString()}+`;
            } else if (salaryMax) {
              return `Up to ‚Çπ${salaryMax.toLocaleString()}`;
            } else {
              return "Salary not specified";
            }
          }

          function viewJobDetails(jobId) {
            // Navigate to job details page with authentication token
            const token = getJwtToken();
            if (token) {
              window.open(
                `/job-details?id=${jobId}&token=${encodeURIComponent(token)}`,
                "_blank"
              );
            } else {
              alert("Please log in to view job details");
              window.location.href = "http://localhost:8083/login";
            }
          }

          async function applyToJob(jobId) {
            if (!currentApplicantId) {
              alert("Please login first");
              return;
            }

            try {
              const response = await fetch("/api/applications", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  ...getAuthHeaders(),
                },
                body: JSON.stringify({ jobId: jobId }),
              });

              if (response.ok) {
                alert("Application submitted successfully!");
                await loadApplications();
              } else {
                const error = await response.text();
                alert("Failed to apply: " + error);
              }
            } catch (error) {
              alert("Failed to apply: " + error.message);
            }
          }

          async function loadApplications() {
            try {
              const response = await fetch(
                `/api/applications/my-applications`,
                {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                    ...getAuthHeaders(),
                  },
                }
              );

              if (response.ok) {
                const applications = await response.json();
                displayApplications(applications);
              } else {
                const errorText = await response.text();
              }
            } catch (error) {
              // Silent failure for applications loading
            }
          }

          function displayApplications(applications) {
            const applicationsList =
              document.getElementById("applicationsList");
            applicationsList.innerHTML = "";

            if (applications.length === 0) {
              applicationsList.innerHTML =
                '<p class="no-items">No applications yet.</p>';
              return;
            }

            applications.forEach((application) => {
              const appDiv = document.createElement("div");
              appDiv.className = "application-item";

              // Get status styling
              const statusClass = getStatusClass(application.status);

              appDiv.innerHTML = `
                <div class="application-status ${statusClass}">${
                application.status
              }</div>
                <h4>${application.job.title}</h4>
                <p class="company">${application.job.companyName}</p>
                <p><strong>Applied:</strong> ${formatDate(
                  application.appliedDate
                )}</p>
                ${
                  application.status === "APPLIED"
                    ? `<button class="btn btn-sm btn-outline" onclick="withdrawApplication(${application.applicationId})">Withdraw</button>`
                    : ""
                }
              `;
              applicationsList.appendChild(appDiv);
            });
          }

          function getStatusClass(status) {
            switch (status) {
              case "APPLIED":
                return "status-applied";
              case "SHORTLISTED":
                return "status-shortlisted";
              case "HIRED":
                return "status-hired";
              case "REJECTED":
                return "status-rejected";
              default:
                return "status-applied";
            }
          }

          function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            });
          }

          async function withdrawApplication(applicationId) {
            if (!confirm("Are you sure you want to withdraw this application?"))
              return;

            try {
              const response = await fetch(
                `/api/applications/${applicationId}`,
                {
                  method: "DELETE",
                  headers: {
                    "Content-Type": "application/json",
                    ...getAuthHeaders(),
                  },
                }
              );

              if (response.ok) {
                alert("Application withdrawn successfully!");
                await loadApplications();
              } else {
                const error = await response.text();
                alert("Failed to withdraw application: " + error);
              }
            } catch (error) {
              alert("Failed to withdraw application: " + error.message);
            }
          }

          // Load application statistics
          async function loadApplicationStats() {
            try {
              const response = await fetch(
                "/api/applications/my-applications",
                {
                  headers: getAuthHeaders(),
                }
              );

              if (response.ok) {
                const applications = await response.json();
                updateApplicationStats(applications);
              } else {
                console.error("Failed to load application stats");
                // Set default values
                updateApplicationStats([]);
              }
            } catch (error) {
              console.error("Error loading application stats:", error);
              updateApplicationStats([]);
            }
          }

          // Update application statistics display
          function updateApplicationStats(applications) {
            const total = applications.length;
            const pending = applications.filter(
              (app) => app.status === "APPLIED"
            ).length;
            const shortlisted = applications.filter(
              (app) => app.status === "SHORTLISTED"
            ).length;
            const hired = applications.filter(
              (app) => app.status === "HIRED"
            ).length;
            const rejected = applications.filter(
              (app) => app.status === "REJECTED"
            ).length;

            document.getElementById("totalApplications").textContent = total;
            document.getElementById("pendingApplications").textContent =
              pending;
            document.getElementById("shortlistedApplications").textContent =
              shortlisted;
            document.getElementById("hiredApplications").textContent = hired;
            document.getElementById("rejectedApplications").textContent =
              rejected;
          }

          async function logout() {
            // Remove all user data from localStorage
            localStorage.removeItem("authToken");
            localStorage.removeItem("jwtToken");
            localStorage.removeItem("userName");
            localStorage.removeItem("userEmail");
            localStorage.removeItem("userId");
            // Optionally remove other related keys if needed
            window.location.href = "http://localhost:8083/login";
          }

          // Initialize page
          document.addEventListener("DOMContentLoaded", async function () {
            // Give AuthHelper more time to process URL tokens and initialize
            await new Promise((resolve) => setTimeout(resolve, 200));

            // Now check authentication
            checkAuth();
            await loadApplicationStats(); // Load application statistics
            await loadJobs(); // Load job recommendations
            await loadApplications(); // Load user applications
          });
        </script>
      </div>
    </div>
  </body>
</html>
