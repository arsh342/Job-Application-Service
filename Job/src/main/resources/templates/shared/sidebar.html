<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <style>
      /* Sidebar Styles */
      .sidebar {
        width: 280px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-color);
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        z-index: 1000;
      }

      .sidebar-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .logo-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
      }

      .theme-toggle {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 18px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .theme-toggle:hover {
        background: var(--hover-bg);
        transform: scale(1.05);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      .user-details h4 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .user-details p {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .nav-menu {
        padding: 16px 0;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        color: var(--text-secondary);
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 14px;
      }

      .nav-item:hover {
        background: var(--hover-bg);
        color: var(--text-primary);
      }

      .nav-item.active {
        background: rgba(61, 213, 152, 0.1);
        color: var(--accent-color);
        border-left: 4px solid var(--accent-color);
        border-bottom-right-radius: 20px;
        border-top-right-radius: 20px;
      }

      .nav-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-icon svg {
        width: 100%;
        height: 100%;
        fill: currentColor;
      }

      .nav-item .nav-icon {
        color: var(--text-secondary);
      }

      .nav-item:hover .nav-icon {
        color: var(--text-primary);
      }

      .nav-item.active .nav-icon {
        color: var(--accent-color);
      }

      .logo-dot {
        width: 8px;
        height: 8px;
        background-color: #3dd598 !important;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
        display: block;
        flex-shrink: 0;
      }

      .logo-dots-container {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .logo-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .logo-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes pulse {
        0%, 100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.6;
          transform: scale(0.8);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="sidebar" th:fragment="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-dots-container">
            <div class="logo-dot"></div>
            <div class="logo-dot"></div>
            <div class="logo-dot"></div>
          </div>
          <div>Skillfind</div>
        </div>
        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">
          üåô
        </button>
      </div>

      <div class="user-info">
        <div
          class="user-avatar"
          id="userAvatar"
          th:text="${userName != null ? #strings.substring(userName,0,1).toUpperCase() : 'U'}"
        >
          U
        </div>
        <div class="user-details">
          <h4 id="userName" th:text="${userName ?: 'User'}"></h4>
          <p id="userEmail" th:text="${userEmail ?: 'user@example.com'}"></p>
        </div>
      </div>

      <div class="nav-menu">
        <a
          href="#"
          class="nav-item"
          id="nav-dashboard"
          onclick="navigateToPage('/dashboard')"
        >
          <div class="nav-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
              <!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
              <path
                d="M341.8 72.6C329.5 61.2 310.5 61.2 298.3 72.6L74.3 280.6C64.7 289.6 61.5 303.5 66.3 315.7C71.1 327.9 82.8 336 96 336L112 336L112 512C112 547.3 140.7 576 176 576L464 576C499.3 576 528 547.3 528 512L528 336L544 336C557.2 336 569 327.9 573.8 315.7C578.6 303.5 575.4 289.5 565.8 280.6L341.8 72.6zM304 384L336 384C362.5 384 384 405.5 384 432L384 528L256 528L256 432C256 405.5 277.5 384 304 384z"
              />
            </svg>
          </div>
          Dashboard
        </a>
        <a
          href="#"
          class="nav-item"
          id="nav-create-job"
          onclick="navigateToPage('/create-job')"
        >
          <div class="nav-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
              <!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
              <path
                d="M352 128C352 110.3 337.7 96 320 96C302.3 96 288 110.3 288 128L288 288L128 288C110.3 288 96 302.3 96 320C96 337.7 110.3 352 128 352L288 352L288 512C288 529.7 302.3 544 320 544C337.7 544 352 529.7 352 512L352 352L512 352C529.7 352 544 337.7 544 320C544 302.3 529.7 288 512 288L352 288L352 128z"
              />
            </svg>
          </div>
          Create Job
        </a>
        <a
          href="#"
          class="nav-item"
          id="nav-job-listings"
          onclick="navigateToPage('/job-listings')"
        >
          <div class="nav-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
              <!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
              <path
                d="M128 128C92.7 128 64 156.7 64 192L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 192C576 156.7 547.3 128 512 128L128 128zM224 384C224 401.7 209.7 416 192 416C174.3 416 160 401.7 160 384C160 366.3 174.3 352 192 352C209.7 352 224 366.3 224 384zM192 288C174.3 288 160 273.7 160 256C160 238.3 174.3 224 192 224C209.7 224 224 238.3 224 256C224 273.7 209.7 288 192 288zM312 232L456 232C469.3 232 480 242.7 480 256C480 269.3 469.3 280 456 280L312 280C298.7 280 288 269.3 288 256C288 242.7 298.7 232 312 232zM312 360L456 360C469.3 360 480 370.7 480 384C480 397.3 469.3 408 456 408L312 408C298.7 408 288 397.3 288 384C288 370.7 298.7 360 312 360z"
              />
            </svg>
          </div>
          My Job Listings
        </a>
        <!-- <a
          href="#"
          class="nav-item"
          id="nav-profile"
          onclick="navigateToPage('/profile')"
        >
          <div class="nav-icon">üë§</div>
          Profile
        </a> -->
        <button type="button" class="nav-item" onclick="openLogoutModal()">
          <div class="nav-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
              <!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
              <path
                d="M569 337C578.4 327.6 578.4 312.4 569 303.1L425 159C418.1 152.1 407.8 150.1 398.8 153.8C389.8 157.5 384 166.3 384 176L384 256L272 256C245.5 256 224 277.5 224 304L224 336C224 362.5 245.5 384 272 384L384 384L384 464C384 473.7 389.8 482.5 398.8 486.2C407.8 489.9 418.1 487.9 425 481L569 337zM224 160C241.7 160 256 145.7 256 128C256 110.3 241.7 96 224 96L160 96C107 96 64 139 64 192L64 448C64 501 107 544 160 544L224 544C241.7 544 256 529.7 256 512C256 494.3 241.7 480 224 480L160 480C142.3 480 128 465.7 128 448L128 192C128 174.3 142.3 160 160 160L224 160z"
              />
            </svg>
          </div>
          Logout
        </button>

        <!-- Logout Confirmation Modal (inside sidebar fragment) -->
        <div
          id="logoutModal"
          style="
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
            z-index: 1000;
          "
        >
          <div
            style="
              background: #fff;
              padding: 20px;
              border-radius: 12px;
              width: 90%;
              max-width: 360px;
              box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            "
          >
            <h3 style="margin: 0 0 8px 0; color: #111827">Confirm Logout</h3>
            <p style="margin: 0 0 16px 0; color: #4b5563; font-size: 14px">
              Are you sure you want to log out?
            </p>
            <div style="display: flex; gap: 10px; justify-content: flex-end">
              <button
                onclick="closeLogoutModal()"
                style="
                  padding: 8px 14px;
                  border: 1px solid #d1d5db;
                  background: #fff;
                  border-radius: 8px;
                  cursor: pointer;
                "
              >
                Cancel
              </button>
              <button
                onclick="confirmLogout()"
                style="
                  padding: 8px 14px;
                  background: #ef4444;
                  color: #fff;
                  border: 0;
                  border-radius: 8px;
                  cursor: pointer;
                "
              >
                Log out
              </button>
            </div>
          </div>
        </div>

        <script>
          // Inline fallback so sidebar works even if script fragment isn't included
          window.openLogoutModal = function () {
            var m = document.getElementById("logoutModal");
            if (m) m.style.display = "flex";
          };
          window.closeLogoutModal = function () {
            var m = document.getElementById("logoutModal");
            if (m) m.style.display = "none";
          };
          window.confirmLogout = function () {
            if (typeof window.logout === "function") {
              try {
                window.logout();
              } catch (e) {
                const authUrl = window.location.hostname === 'localhost' ? 'http://localhost:8083' : 'https://job-application-service-production.up.railway.app';
                window.location.href = authUrl + "/login";
              }
            } else {
              window.location.href = "http://localhost:8083/login";
            }
          };
        </script>
      </div>
    </div>

    <script th:fragment="sidebar-script">
      // Sidebar functionality
      function initializeSidebar() {
        // Check if user info is already set via Thymeleaf (server-side)
        const userNameElement = document.getElementById("userName");
        const userEmailElement = document.getElementById("userEmail");

        // If Thymeleaf didn't set the values (e.g., from server-side model), try localStorage
        if (
          !userNameElement.textContent ||
          userNameElement.textContent === "User"
        ) {
          const userName = localStorage.getItem("userName");
          const userEmail = localStorage.getItem("userEmail");

          if (userName && userEmail) {
            userNameElement.textContent = userName;
            userEmailElement.textContent = userEmail;
            document.getElementById("userAvatar").textContent = userName
              .charAt(0)
              .toUpperCase();
          }
        }

        // Set active navigation item based on current page
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll(".nav-item");

        navItems.forEach((item) => {
          item.classList.remove("active");
        });

        // Set active state based on current path
        if (currentPath === "/dashboard" || currentPath === "/") {
          document.getElementById("nav-dashboard").classList.add("active");
        } else if (currentPath === "/create-job") {
          document.getElementById("nav-create-job").classList.add("active");
        } else if (currentPath === "/job-listings") {
          document.getElementById("nav-job-listings").classList.add("active");
        } else if (currentPath === "/profile") {
          document.getElementById("nav-profile").classList.add("active");
        } else if (currentPath.includes("job-details")) {
          // For job details, highlight job listings
          document.getElementById("nav-job-listings").classList.add("active");
        }
      }

      // JWT utility functions for sidebar
      function getJwtToken() {
        return (
          localStorage.getItem("authToken") ||
          localStorage.getItem("jwtToken") ||
          sessionStorage.getItem("authToken")
        );
      }

      function removeJwtToken() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("userName");
        localStorage.removeItem("userEmail");
        localStorage.removeItem("userId");
        sessionStorage.removeItem("authToken");
      }

      function navigateToPage(page) {
        const token = getJwtToken();
        if (token) {
          window.location.href = `${page}?token=${encodeURIComponent(token)}`;
        } else {
          window.location.href = page;
        }
      }

      async function logout() {
        removeJwtToken();
        window.location.href = "http://localhost:8083/login";
      }

      // Initialize sidebar when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initializeSidebar();
      });

      // Logout confirmation modal
      function openLogoutModal() {
        const modal = document.getElementById("logoutModal");
        if (modal) modal.style.display = "flex";
      }
      function closeLogoutModal() {
        const modal = document.getElementById("logoutModal");
        if (modal) modal.style.display = "none";
      }
      function confirmLogout() {
        if (typeof window.logout === "function") {
          try {
            window.logout();
          } catch (e) {
            fallbackLogout();
          }
        } else {
          fallbackLogout();
        }
      }
      function fallbackLogout() {
        try {
          localStorage.removeItem("authToken");
        } catch (e) {}
        window.location.href = "http://localhost:8083/login";
      }
    </script>

    <!-- Logout Confirmation Modal -->
    <div
      id="logoutModal"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        align-items: center;
        justify-content: center;
        z-index: 1000;
      "
    >
      <div
        style="
          background: #fff;
          padding: 20px;
          border-radius: 16px;
          width: 90%;
          max-width: 360px;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        "
      >
        <h3 style="margin: 0 0 8px 0; color: #111827">Confirm Logout</h3>
        <p style="margin: 0 0 16px 0; color: #4b5563; font-size: 14px">
          Are you sure you want to log out?
        </p>
        <div style="display: flex; gap: 10px; justify-content: flex-end">
          <button
            onclick="closeLogoutModal()"
            style="
              padding: 8px 14px;
              border: 1px solid #d1d5db;
              background: #fff;
              border-radius: 20px;
              cursor: pointer;
            "
          >
            Cancel
          </button>
          <button
            onclick="confirmLogout()"
            style="
              padding: 8px 14px;
              background: #ef4444;
              color: #fff;
              border: 0;
              border-radius: 20px;
              cursor: pointer;
            "
          >
            Log out
          </button>
        </div>
      </div>
    </div>

    <!-- Theme Toggle Script Fragment -->
    <div th:fragment="sidebar-script">
      <script>
        // Theme toggle functionality
        function initTheme() {
          const savedTheme = localStorage.getItem('theme') || 'dark';
          if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
          }
          updateThemeIcon();
        }

        function toggleTheme() {
          document.body.classList.toggle('light-mode');
          const theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
          localStorage.setItem('theme', theme);
          updateThemeIcon();
        }

        function updateThemeIcon() {
          const themeToggle = document.getElementById('themeToggle');
          if (themeToggle) {
            themeToggle.textContent = document.body.classList.contains('light-mode') ? '‚òÄÔ∏è' : 'üåô';
          }
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', initTheme);
        // Also init immediately in case DOMContentLoaded already fired
        if (document.readyState === 'loading') {
          // Still loading
        } else {
          // DOM is ready
          initTheme();
        }
      </script>
    </div>
  </body>
</html>
