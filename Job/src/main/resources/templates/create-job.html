<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create/Edit Job - Job Application Service</title>

    <!-- Pre-authentication script - runs immediately for page reload handling -->
    <script src="/js/pre-auth.js"></script>
    <script src="/js/auth-helper.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }

      .layout {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 280px;
        background: white;
        border-right: 1px solid #e5e9f2;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        z-index: 1000;
      }

      .sidebar-header {
        padding: 24px;
        border-bottom: 1px solid #e5e9f2;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
      }

      .logo-icon {
        width: 50px;
        height: 50px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 24px;
        border-bottom: 1px solid #e5e9f2;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #b7d7f9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      .user-details h4 {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
      }

      .user-details p {
        font-size: 12px;
        color: #6b7280;
      }

      .nav-menu {
        padding: 16px 0;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        color: #6b7280;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 14px;
      }

      .nav-item:hover {
        background: #f8fafc;
        color: #374151;
      }

      .nav-item.active {
        background: #f0f9ff;
        color: #0ea5e9;
        border-right: 3px solid #0ea5e9;
        border-bottom-right-radius: 20px;
        border-top-right-radius: 20px;
      }

      .nav-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 280px;
        padding: 32px;
      }

      .page-header {
        margin-bottom: 32px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .page-subtitle {
        font-size: 16px;
        color: #6b7280;
      }

      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e9f2;
        overflow: hidden;
      }

      .form-container {
        background: white;
        padding: 32px;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        font-weight: 500;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-secondary {
        background: #f8fafc;
        color: #374151;
        border: 1px solid #e5e9f2;
      }

      .btn-success {
        background: green;
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary:hover {
        background: #f1f5f9;
        transform: translateY(-1px);
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(132, 250, 176, 0.3);
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(250, 112, 154, 0.3);
      }

      .form-section {
        padding: 40px;
      }

      .form-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #374151;
        font-weight: 600;
        font-size: 14px;
      }

      input[type="text"],
      input[type="number"],
      textarea,
      select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        font-size: 16px;
        transition: all 0.2s ease;
        background: #f8fafc;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
      }

      textarea {
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
      }

      .action-buttons {
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid #e5e9f2;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
      }

      .error {
        background: #fef2f2;
        color: #dc2626;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
        text-align: center;
        border: 1px solid #fecaca;
        font-weight: 500;
      }

      .success {
        background: #f0fdf4;
        color: #16a34a;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
        text-align: center;
        border: 1px solid #bbf7d0;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
          border-radius: 4px;
        }

        .header {
          padding: 20px;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .form-section {
          padding: 20px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .nav-buttons,
        .action-buttons {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <!-- Include shared sidebar -->
      <div th:replace="shared/sidebar :: sidebar"></div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="page-header">
          <h1 class="page-title" id="pageTitle">Create New Job</h1>
          <p class="page-subtitle" id="pageDescription">
            Fill in the details below to create a new job posting
          </p>
        </div>

        <div class="container">
          <div class="form-container">
            <div id="messageContainer"></div>

            <form id="jobForm">
              <input type="hidden" id="jobId" value="" />

              <div class="form-group">
                <label for="jobTitle">Job Title *</label>
                <input
                  type="text"
                  id="jobTitle"
                  required
                  placeholder="e.g., Senior Software Engineer"
                />
              </div>

              <div class="form-group">
                <label for="jobDescription">Job Description *</label>
                <textarea
                  id="jobDescription"
                  required
                  placeholder="Describe the role, responsibilities, and requirements..."
                ></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="jobLocation">Location *</label>
                  <input
                    type="text"
                    id="jobLocation"
                    required
                    placeholder="e.g., New York, NY"
                  />
                </div>
                <div class="form-group">
                  <label for="jobCompany">Company *</label>
                  <input
                    type="text"
                    id="jobCompany"
                    required
                    placeholder="Company name"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="jobSalaryMin">Minimum Salary</label>
                  <input
                    type="number"
                    id="jobSalaryMin"
                    step="0.01"
                    placeholder="e.g., 50000"
                  />
                </div>
                <div class="form-group">
                  <label for="jobSalaryMax">Maximum Salary</label>
                  <input
                    type="number"
                    id="jobSalaryMax"
                    step="0.01"
                    placeholder="e.g., 80000"
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="jobStatus">Job Status</label>
                <select id="jobStatus">
                  <option value="OPEN">Open</option>
                  <option value="CLOSED">Closed</option>
                </select>
              </div>

              <div class="action-buttons">
                <button
                  type="button"
                  class="btn btn-success"
                  onclick="saveJob()"
                  id="saveButton"
                >
                  Create Job
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="resetForm()"
                >
                  Reset Form
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Include shared sidebar script -->
      <div th:replace="shared/sidebar :: sidebar-script"></div>

      <script>
        let isEditMode = false;
        let currentJobId = null;

        // Additional JWT utility functions (supplementing sidebar)
        function getAuthHeaders() {
          const token = getJwtToken();
          console.log(
            "Retrieved token:",
            token ? "Token exists" : "No token found"
          );
          console.log(
            "Token value:",
            token ? token.substring(0, 20) + "..." : "null"
          );
          return token ? { Authorization: `Bearer ${token}` } : {};
        }

        function removeJwtToken() {
          localStorage.removeItem("authToken");
          localStorage.removeItem("jwtToken");
          sessionStorage.removeItem("authToken");
        }

        function navigateToPage(page) {
          const token = getJwtToken();
          if (token) {
            window.location.href = `${page}?token=${encodeURIComponent(token)}`;
          } else {
            window.location.href = page;
          }
        }

        async function logout() {
          removeJwtToken();
          window.location.href = "http://localhost:8083/login";
        }

        function showMessage(message, type = "success") {
          const messageContainer = document.getElementById("messageContainer");
          const className = type === "error" ? "error" : "success";
          messageContainer.innerHTML = `<div class="${className}">${message}</div>`;

          // Auto-hide success messages after 5 seconds
          if (type === "success") {
            setTimeout(() => {
              messageContainer.innerHTML = "";
            }, 5000);
          }
        }

        async function loadJobData(jobId) {
          try {
            const response = await fetch(`/api/jobs/${jobId}`, {
              headers: getAuthHeaders(),
            });

            if (response.ok) {
              const job = await response.json();
              populateForm(job);
            } else {
              showMessage("Failed to load job data", "error");
            }
          } catch (error) {
            console.error("Error loading job:", error);
            showMessage("Error loading job data", "error");
          }
        }

        function populateForm(job) {
          document.getElementById("jobId").value = job.jobId;
          document.getElementById("jobTitle").value = job.title || "";
          document.getElementById("jobDescription").value =
            job.description || "";
          document.getElementById("jobLocation").value = job.location || "";
          document.getElementById("jobCompany").value = job.company || "";
          document.getElementById("jobSalaryMin").value = job.salaryMin || "";
          document.getElementById("jobSalaryMax").value = job.salaryMax || "";
          document.getElementById("jobStatus").value = job.status || "OPEN";
        }

        async function saveJob() {
          const jobData = {
            title: document.getElementById("jobTitle").value,
            description: document.getElementById("jobDescription").value,
            location: document.getElementById("jobLocation").value,
            company: document.getElementById("jobCompany").value,
            salaryMin:
              parseFloat(document.getElementById("jobSalaryMin").value) || null,
            salaryMax:
              parseFloat(document.getElementById("jobSalaryMax").value) || null,
            status: document.getElementById("jobStatus").value,
          };

          // Add employer information if available
          const userId = localStorage.getItem("userId");
          if (userId) {
            jobData.employerId = parseInt(userId);
          }

          // Basic validation
          if (
            !jobData.title ||
            !jobData.description ||
            !jobData.location ||
            !jobData.company
          ) {
            showMessage("Please fill in all required fields", "error");
            return;
          }

          try {
            const saveButton = document.getElementById("saveButton");
            saveButton.disabled = true;
            saveButton.textContent = isEditMode ? "Updating..." : "Creating...";

            const url = isEditMode ? `/api/jobs/${currentJobId}` : "/api/jobs";
            const method = isEditMode ? "PUT" : "POST";

            // Debug logging
            console.log("Making request to:", url);
            console.log("Method:", method);
            console.log("Headers:", {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            });
            console.log("Body:", JSON.stringify(jobData));

            const response = await fetch(url, {
              method: method,
              headers: {
                "Content-Type": "application/json",
                ...getAuthHeaders(),
              },
              body: JSON.stringify(jobData),
            });

            console.log("Response status:", response.status);
            console.log("Response headers:", response.headers);

            if (response.ok) {
              const result = await response.json();
              const message = isEditMode
                ? "Job updated successfully!"
                : "Job created successfully!";
              showMessage(message);

              // Redirect to dashboard after a short delay
              setTimeout(() => {
                navigateToPage("/dashboard");
              }, 2000);
            } else {
              const errorText = await response.text();
              console.error("Error response:", errorText);
              showMessage(
                `Failed to ${
                  isEditMode ? "update" : "create"
                } job: ${errorText}`,
                "error"
              );
            }
          } catch (error) {
            console.error("Error saving job:", error);
            showMessage(
              `Error ${isEditMode ? "updating" : "creating"} job: ${
                error.message
              }`,
              "error"
            );
          } finally {
            const saveButton = document.getElementById("saveButton");
            saveButton.disabled = false;
            saveButton.textContent = isEditMode ? "Update Job" : "Create Job";
          }
        }

        function resetForm() {
          document.getElementById("jobForm").reset();
          document.getElementById("messageContainer").innerHTML = "";
          if (!isEditMode) {
            document.getElementById("jobStatus").value = "OPEN";
          }
        }

        // Test authentication function
        async function testAuthentication() {
          console.log("Testing authentication...");
          try {
            const response = await fetch("/api/jobs", {
              method: "GET",
              headers: getAuthHeaders(),
            });

            console.log("Auth test response status:", response.status);

            if (response.ok) {
              console.log("Authentication test passed");
              return true;
            } else {
              console.error("Authentication test failed:", response.status);
              const errorText = await response.text();
              console.error("Error details:", errorText);
              return false;
            }
          } catch (error) {
            console.error("Authentication test error:", error);
            return false;
          }
        }

        // Initialize page on load
        window.addEventListener("load", function () {
          // Check authentication
          const token = getJwtToken();
          console.log("Page load - checking authentication");
          console.log("Token exists:", !!token);

          if (!token) {
            console.log("No token found, redirecting to login");
            window.location.href = "http://localhost:8083/login";
            return;
          }

          // Debug user info
          const userName = localStorage.getItem("userName");
          const userId = localStorage.getItem("userId");
          const userType = localStorage.getItem("userType");

          console.log("User info:", { userName, userId, userType });

          // Update user info in sidebar
          if (userName) {
            const userNameElement = document.getElementById("userName");
            const userAvatar = document.getElementById("userAvatar");

            if (userNameElement) {
              userNameElement.textContent = userName;
            }

            if (userAvatar) {
              userAvatar.textContent = userName.charAt(0).toUpperCase();
            }
          } else {
            console.warn("No userName found in localStorage");
          }

          // Extract token from URL if present
          const urlParams = new URLSearchParams(window.location.search);
          const urlToken = urlParams.get("token");
          if (urlToken) {
            console.log("Token found in URL, storing it");
            localStorage.setItem("authToken", urlToken);
            // Clean URL
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );
          }

          // Check if this is edit mode
          const editJobId = urlParams.get("edit");
          if (editJobId) {
            console.log("Edit mode detected for job ID:", editJobId);
            isEditMode = true;
            currentJobId = editJobId;

            // Update UI for edit mode
            document.getElementById("pageTitle").textContent = "Edit Job";
            document.getElementById("pageDescription").textContent =
              "Update the job details below";
            document.getElementById("saveButton").textContent = "Update Job";

            // Load job data
            loadJobData(editJobId);
          } else {
            console.log("Create mode detected");
          }

          // Test authentication after setup
          setTimeout(async () => {
            const authResult = await testAuthentication();
            if (!authResult) {
              showMessage(
                "Authentication issue detected. Please try logging in again.",
                "error"
              );
            }
          }, 1000);
        });
      </script>
    </div>
  </body>
</html>
