<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - Job Portal</title>
    <script src="/js/pre-auth.js"></script>
    <script src="/js/auth-helper.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      body {
        background: #f5f7fa;
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }

      .layout {
        display: flex;
        min-height: 100vh;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 280px;
        padding: 32px;
      }

      .page-header {
        margin-bottom: 32px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .page-subtitle {
        font-size: 16px;
        color: #6b7280;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        overflow: hidden;
      }

      .header h1 {
        font-size: 1.75rem;
        font-weight: 600;
      }

      .header-buttons {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        transition: background-color 0.15s ease-in-out;
        font-size: 0.875rem;
      }

      .btn-primary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .btn-primary:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .profile-container {
        padding: 40px;
      }

      .profile-section {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
      }

      .profile-section h2 {
        color: #495057;
        font-size: 1.25rem;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 1.25rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #495057;
        font-size: 0.875rem;
      }

      input,
      textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        background: white;
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
      }

      textarea {
        resize: vertical;
        min-height: 120px;
      }

      button {
        padding: 15px 30px;
        margin: 8px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .save-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
      }

      .save-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
      }

      .cancel-btn {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
        color: white;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
      }

      .cancel-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
      }

      .success-msg {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        padding: 15px 20px;
        border-radius: 8px;
        margin-top: 15px;
        border-left: 4px solid #28a745;
        font-weight: 600;
      }

      .error-msg {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
        padding: 15px 20px;
        border-radius: 8px;
        margin-top: 15px;
        border-left: 4px solid #dc3545;
        font-weight: 600;
      }

      .password-section {
        border-top: 3px solid #667eea;
        padding-top: 30px;
        margin-top: 30px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 20px;
          text-align: center;
        }

        .header h1 {
          font-size: 2rem;
        }

        .profile-container {
          padding: 20px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <!-- Include shared sidebar -->
      <div th:replace="shared/sidebar :: sidebar"></div>

      <div class="main-content">
        <div class="page-header">
          <h1 class="page-title">Profile Management</h1>
          <p class="page-subtitle">
            Manage your company information and settings
          </p>
        </div>
        <div class="container">
          <div class="profile-container">
            <div class="profile-section">
              <h2>Company Information</h2>
              <form id="profileForm">
                <div class="form-group">
                  <label for="companyName">Company Name:</label>
                  <input
                    type="text"
                    id="companyName"
                    name="companyName"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="email">Email:</label>
                  <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    readonly
                  />
                </div>

                <div class="form-group">
                  <label for="contactNumber">Contact Number:</label>
                  <input type="tel" id="contactNumber" name="contactNumber" />
                </div>

                <div class="form-group">
                  <label for="address">Address:</label>
                  <textarea id="address" name="address" rows="3"></textarea>
                </div>

                <div class="form-group">
                  <label for="website">Website:</label>
                  <input type="url" id="website" name="website" />
                </div>

                <div class="form-group">
                  <label for="description">Company Description:</label>
                  <textarea
                    id="description"
                    name="description"
                    rows="4"
                  ></textarea>
                </div>

                <button
                  type="button"
                  onclick="updateProfile()"
                  class="save-btn"
                >
                  Update Profile
                </button>
                <div id="profileMessage"></div>
              </form>
            </div>

            <div class="profile-section">
              <div class="password-section">
                <h2>Change Password</h2>
                <form id="passwordForm">
                  <div class="form-group">
                    <label for="currentPassword">Current Password:</label>
                    <input
                      type="password"
                      id="currentPassword"
                      name="currentPassword"
                      required
                    />
                  </div>

                  <div class="form-group">
                    <label for="newPassword">New Password:</label>
                    <input
                      type="password"
                      id="newPassword"
                      name="newPassword"
                      required
                      minlength="8"
                      pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*()_+\-=\[\]{};':&quot;\\|,.<>/?]).*$"
                      title="Password must be at least 8 characters and contain at least one uppercase letter, one lowercase letter, one number and one special character"
                    />
                    <small
                      style="
                        color: #6c757d;
                        font-size: 12px;
                        margin-top: 4px;
                        display: block;
                      "
                    >
                      Must be at least 8 characters with uppercase, lowercase,
                      number and special character
                    </small>
                  </div>

                  <div class="form-group">
                    <label for="confirmPassword">Confirm New Password:</label>
                    <input
                      type="password"
                      id="confirmPassword"
                      name="confirmPassword"
                      required
                      minlength="8"
                    />
                  </div>

                  <button
                    type="button"
                    onclick="changePassword()"
                    class="save-btn"
                  >
                    Change Password
                  </button>
                  <div id="passwordMessage"></div>
                </form>
              </div>
            </div>

            <div class="profile-section">
              <h2>Account Statistics</h2>
              <div id="stats">
                <p>
                  <strong>Total Jobs Posted:</strong>
                  <span id="totalJobs">Loading...</span>
                </p>
                <p>
                  <strong>Active Jobs:</strong>
                  <span id="activeJobs">Loading...</span>
                </p>
                <p>
                  <strong>Total Applications Received:</strong>
                  <span id="totalApplications">Loading...</span>
                </p>
                <p>
                  <strong>Member Since:</strong>
                  <span id="memberSince">Loading...</span>
                </p>
              </div>
            </div>
          </div>

          <script>
            let currentEmployer = null;

            // JWT utility functions
            function getJwtToken() {
              return (
                localStorage.getItem("authToken") ||
                localStorage.getItem("jwtToken") ||
                sessionStorage.getItem("authToken")
              );
            }

            function setJwtToken(token) {
              localStorage.setItem("authToken", token);
              localStorage.setItem("jwtToken", token); // Keep for compatibility
            }

            function removeJwtToken() {
              localStorage.removeItem("authToken");
              localStorage.removeItem("jwtToken");
              sessionStorage.removeItem("authToken");
            }

            function getAuthHeaders() {
              const token = getJwtToken();
              return token ? { Authorization: `Bearer ${token}` } : {};
            }

            window.addEventListener("load", async function () {
              console.log("Profile page loading...");

              // Auth-helper.js has already processed URL token, so just get the stored token
              let token = getJwtToken();

              // If no token in localStorage, try to get it from Thymeleaf model (server-side)
              const thymeleafToken = /*[[${token}]]*/ null;
              if (!token && thymeleafToken) {
                token = thymeleafToken;
                setJwtToken(thymeleafToken);
              }

              console.log("Token found:", token ? "YES" : "NO");
              console.log("Thymeleaf token:", thymeleafToken ? "YES" : "NO");

              // Since backend already authenticated us to render this page,
              // let's not redirect even if client-side token is missing
              // if (!token) {
              //   window.location.href = "http://localhost:8083/login";
              //   return;
              // }

              try {
                // Use Thymeleaf model data as primary source, localStorage as fallback
                const userType =
                  /*[[${userType}]]*/ localStorage.getItem("userType");
                const userName =
                  /*[[${userName}]]*/ localStorage.getItem("userName");
                const userId = /*[[${userId}]]*/ localStorage.getItem("userId");

                console.log("Profile data:", { userType, userName, userId });

                if (userType && userName && userId) {
                  // Use stored user information
                  currentEmployer = {
                    employerId: parseInt(userId),
                    name: userName,
                    userType: userType,
                  };
                  currentEmployerId = parseInt(userId);

                  document.getElementById(
                    "welcomeMessage"
                  ).textContent = `Welcome, ${userName}!`;
                  await loadProfile();
                  await loadStats();
                  return;
                }

                // Fallback: try to validate token with Authentication Service
                const response = await fetch(
                  "http://localhost:8083/api/auth/validate",
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      ...getAuthHeaders(),
                    },
                  }
                );

                if (!response.ok) {
                  removeJwtToken();
                  window.location.href = "http://localhost:8083/login";
                  return;
                }

                const userData = await response.json();
                if (userData.valid) {
                  currentEmployer = {
                    employerId: userData.userId,
                    name: userData.name,
                    userType: userData.userType,
                  };
                  currentEmployerId = userData.userId;

                  // Store user info for future use
                  localStorage.setItem("userType", userData.userType);
                  localStorage.setItem("userName", userData.name);
                  localStorage.setItem("userId", userData.userId.toString());

                  document.getElementById(
                    "welcomeMessage"
                  ).textContent = `Welcome, ${userData.name}!`;
                  await loadProfile();
                  await loadStats();
                } else {
                  throw new Error("Invalid token");
                }
              } catch (error) {
                removeJwtToken();
                window.location.href = "http://localhost:8083/login";
              }
            });

            async function loadProfile() {
              try {
                const response = await fetch("/api/auth/profile");
                if (response.ok) {
                  const employer = await response.json();

                  document.getElementById("companyName").value =
                    employer.companyName || "";
                  document.getElementById("email").value = employer.email || "";
                  document.getElementById("contactNumber").value =
                    employer.contactNumber || "";
                  document.getElementById("address").value =
                    employer.address || "";
                  document.getElementById("website").value =
                    employer.website || "";
                  document.getElementById("description").value =
                    employer.description || "";
                } else {
                  showMessage(
                    "profileMessage",
                    "Failed to load profile data",
                    "error"
                  );
                }
              } catch (error) {
                showMessage(
                  "profileMessage",
                  "Error loading profile: " + error.message,
                  "error"
                );
              }
            }

            async function loadStats() {
              try {
                // Load job statistics
                const jobsResponse = await fetch("/api/jobs/my-jobs");
                if (jobsResponse.ok) {
                  const jobs = await jobsResponse.json();
                  document.getElementById("totalJobs").textContent =
                    jobs.length;

                  const activeJobs = jobs.filter(
                    (job) => job.status === "OPEN"
                  ).length;
                  document.getElementById("activeJobs").textContent =
                    activeJobs;

                  // Load total applications across all jobs
                  let totalApplications = 0;
                  for (const job of jobs) {
                    try {
                      const appResponse = await fetch(
                        `/api/jobs/${job.jobId}/applications`
                      );
                      if (appResponse.ok) {
                        const applications = await appResponse.json();
                        totalApplications += applications.length;
                      }
                    } catch (error) {
                      console.error(
                        "Error loading applications for job:",
                        job.jobId
                      );
                    }
                  }
                  document.getElementById("totalApplications").textContent =
                    totalApplications;
                }

                // Set member since date (you might want to add this field to employer model)
                if (currentEmployer && currentEmployer.createdDate) {
                  document.getElementById("memberSince").textContent = new Date(
                    currentEmployer.createdDate
                  ).toLocaleDateString();
                } else {
                  document.getElementById("memberSince").textContent = "N/A";
                }
              } catch (error) {
                console.error("Error loading statistics:", error);
              }
            }

            async function updateProfile() {
              const profileData = {
                companyName: document.getElementById("companyName").value,
                contactNumber: document.getElementById("contactNumber").value,
                address: document.getElementById("address").value,
                website: document.getElementById("website").value,
                description: document.getElementById("description").value,
              };

              try {
                const response = await fetch("/api/auth/profile", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(profileData),
                });

                if (response.ok) {
                  showMessage(
                    "profileMessage",
                    "Profile updated successfully!",
                    "success"
                  );
                } else {
                  const error = await response.text();
                  showMessage(
                    "profileMessage",
                    "Failed to update profile: " + error,
                    "error"
                  );
                }
              } catch (error) {
                showMessage(
                  "profileMessage",
                  "Error updating profile: " + error.message,
                  "error"
                );
              }
            }

            async function changePassword() {
              const currentPassword =
                document.getElementById("currentPassword").value;
              const newPassword = document.getElementById("newPassword").value;
              const confirmPassword =
                document.getElementById("confirmPassword").value;

              if (newPassword !== confirmPassword) {
                showMessage(
                  "passwordMessage",
                  "New passwords do not match",
                  "error"
                );
                return;
              }

              if (newPassword.length < 8) {
                showMessage(
                  "passwordMessage",
                  "Password must be at least 8 characters long",
                  "error"
                );
                return;
              }

              // Check for uppercase, lowercase, number and special character
              const hasUppercase = /[A-Z]/.test(newPassword);
              const hasLowercase = /[a-z]/.test(newPassword);
              const hasNumber = /\d/.test(newPassword);
              const hasSpecialChar =
                /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword);

              if (!hasUppercase) {
                showMessage(
                  "passwordMessage",
                  "Password must contain at least one uppercase letter",
                  "error"
                );
                return;
              }

              if (!hasLowercase) {
                showMessage(
                  "passwordMessage",
                  "Password must contain at least one lowercase letter",
                  "error"
                );
                return;
              }

              if (!hasNumber) {
                showMessage(
                  "passwordMessage",
                  "Password must contain at least one number",
                  "error"
                );
                return;
              }

              if (!hasSpecialChar) {
                showMessage(
                  "passwordMessage",
                  "Password must contain at least one special character",
                  "error"
                );
                return;
              }

              const passwordData = {
                currentPassword: currentPassword,
                newPassword: newPassword,
              };

              try {
                const response = await fetch("/api/auth/change-password", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(passwordData),
                });

                if (response.ok) {
                  showMessage(
                    "passwordMessage",
                    "Password changed successfully!",
                    "success"
                  );
                  document.getElementById("passwordForm").reset();
                } else {
                  const error = await response.text();
                  showMessage(
                    "passwordMessage",
                    "Failed to change password: " + error,
                    "error"
                  );
                }
              } catch (error) {
                showMessage(
                  "passwordMessage",
                  "Error changing password: " + error.message,
                  "error"
                );
              }
            }

            function showMessage(elementId, message, type) {
              const messageDiv = document.getElementById(elementId);
              messageDiv.textContent = message;
              messageDiv.className =
                type === "success" ? "success-msg" : "error-msg";

              // Clear message after 5 seconds
              setTimeout(() => {
                messageDiv.textContent = "";
                messageDiv.className = "";
              }, 5000);
            }

            async function logout() {
              try {
                await fetch("/api/auth/logout", { method: "POST" });
                window.location.href = "/login";
              } catch (error) {
                window.location.href = "/login";
              }
            }
          </script>
        </div>
      </div>
    </div>

    <!-- Include shared sidebar script -->
    <div th:replace="shared/sidebar :: sidebar-script"></div>
  </body>
</html>
