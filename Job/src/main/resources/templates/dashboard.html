<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job Portal - Employer Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 2rem;
        font-weight: 600;
      }

      .header-buttons {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .btn-primary:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #333;
      }

      .btn-secondary:hover {
        background: #e9ecef;
        transform: translateY(-2px);
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
      }

      .section {
        margin: 30px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 8px;
        border: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .section h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
      }

      input[type="text"],
      input[type="number"],
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e1e1e1;
        border-radius: 5px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      .job-item {
        background: white;
        margin: 15px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #e1e1e1;
      }

      .job-item h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.3rem;
      }

      .job-item p {
        color: #666;
        margin: 5px 0;
        line-height: 1.5;
      }

      .job-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }

      #welcomeMessage {
        color: white;
        font-weight: 500;
        margin-right: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Job Portal - Employer Dashboard</h1>
        <div class="header-buttons">
          <span id="welcomeMessage"></span>
          <button
            class="btn btn-primary"
            onclick="navigateToPage('/job-listings')"
          >
            Job Listings
          </button>
          <button class="btn btn-primary" onclick="navigateToPage('/profile')">
            Profile
          </button>
          <button class="btn btn-primary" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Create New Job Section -->
      <div class="section">
        <h2>Create New Job</h2>
        <form id="createJobForm">
          <div class="form-group">
            <label for="jobTitle">Job Title:</label>
            <input type="text" id="jobTitle" required />
          </div>
          <div class="form-group">
            <label for="jobDescription">Description:</label>
            <textarea id="jobDescription" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="jobLocation">Location:</label>
            <input type="text" id="jobLocation" required />
          </div>
          <div class="form-group">
            <label for="jobCompany">Company:</label>
            <input type="text" id="jobCompany" required />
          </div>
          <div class="form-group">
            <label for="jobSalaryMin">Minimum Salary:</label>
            <input type="number" id="jobSalaryMin" step="0.01" />
          </div>
          <div class="form-group">
            <label for="jobSalaryMax">Maximum Salary:</label>
            <input type="number" id="jobSalaryMax" step="0.01" />
          </div>
          <button type="button" class="btn btn-success" onclick="createJob()">
            Create Job
          </button>
        </form>
      </div>

      <!-- My Jobs Section -->
      <div class="section">
        <h2>My Jobs</h2>
        <div id="jobsList"></div>
      </div>
    </div>

    <script>
      let currentEmployerId = null;
      let currentEmployer = null;

      // JWT utility functions
      function getJwtToken() {
        return (
          localStorage.getItem("authToken") ||
          localStorage.getItem("jwtToken") ||
          sessionStorage.getItem("authToken")
        );
      }

      function setJwtToken(token) {
        localStorage.setItem("authToken", token);
        localStorage.setItem("jwtToken", token); // Keep for compatibility
      }

      function removeJwtToken() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("jwtToken");
        sessionStorage.removeItem("authToken");
      }

      function getAuthHeaders() {
        const token = getJwtToken();
        return token ? { Authorization: `Bearer ${token}` } : {};
      }

      function navigateToPage(page) {
        const token = getJwtToken();
        if (token) {
          window.location.href = `${page}?token=${encodeURIComponent(token)}`;
        } else {
          window.location.href = page;
        }
      }

      // Check authentication on page load
      window.addEventListener("load", async function () {
        // First check if token is passed via URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get("token");

        if (urlToken) {
          // Store token from URL parameter
          setJwtToken(urlToken);
          // Clean URL by removing token parameter
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
        }

        const token = getJwtToken();
        if (!token) {
          window.location.href = "http://localhost:8083/auth/login";
          return;
        }

        try {
          // Extract user info from stored token data
          const userType = localStorage.getItem("userType");
          const userName = localStorage.getItem("userName");
          const userId = localStorage.getItem("userId");

          if (userType && userName && userId) {
            // Use stored user information
            currentEmployer = {
              employerId: parseInt(userId),
              name: userName,
              userType: userType,
            };
            currentEmployerId = parseInt(userId);

            document.getElementById(
              "welcomeMessage"
            ).textContent = `Welcome, ${userName}!`;
            await loadJobs();
            return;
          }

          // Fallback: try to validate token with Authentication Service
          const response = await fetch(
            "http://localhost:8083/api/auth/validate",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                ...getAuthHeaders(),
              },
            }
          );

          if (!response.ok) {
            removeJwtToken();
            window.location.href = "http://localhost:8083/auth/login";
            return;
          }

          const userData = await response.json();
          if (userData.valid) {
            currentEmployer = {
              employerId: userData.userId,
              name: userData.name,
              userType: userData.userType,
            };
            currentEmployerId = userData.userId;

            // Store user info for future use
            localStorage.setItem("userType", userData.userType);
            localStorage.setItem("userName", userData.name);
            localStorage.setItem("userId", userData.userId.toString());

            document.getElementById(
              "welcomeMessage"
            ).textContent = `Welcome, ${userData.name}!`;
            await loadJobs();
          } else {
            throw new Error("Invalid token");
          }
        } catch (error) {
          removeJwtToken();
          window.location.href = "http://localhost:8083/auth/login";
        }
      });

      async function loadJobs() {
        if (!currentEmployerId) return;

        try {
          const response = await fetch(
            `/api/employers/${currentEmployerId}/jobs`,
            {
              headers: getAuthHeaders(),
            }
          );
          if (response.ok) {
            const jobs = await response.json();
            displayJobs(jobs);
          }
        } catch (error) {
          console.error("Failed to load jobs:", error);
        }
      }

      function displayJobs(jobs) {
        const jobsList = document.getElementById("jobsList");
        jobsList.innerHTML = "";

        if (jobs.length === 0) {
          jobsList.innerHTML = "<p>No jobs posted yet.</p>";
          return;
        }

        jobs.forEach((job) => {
          const jobDiv = document.createElement("div");
          jobDiv.className = "job-item";
          jobDiv.innerHTML = `
                    <h4>${job.title}</h4>
                    <p><strong>Company:</strong> ${job.company}</p>
                    <p><strong>Description:</strong> ${job.description}</p>
                    <p><strong>Location:</strong> ${job.location}</p>
                    <p><strong>Salary:</strong> $${
                      job.salaryMin && job.salaryMax
                        ? `${job.salaryMin} - ${job.salaryMax}`
                        : job.salaryMin
                        ? `${job.salaryMin}+`
                        : job.salaryMax
                        ? `Up to ${job.salaryMax}`
                        : "Not specified"
                    }</p>
                    <p><strong>Status:</strong> ${job.status}</p>
                    <p><strong>Posted:</strong> ${job.postedDate}</p>
                    <button onclick="editJob(${job.jobId})">Edit Job</button>
                    <button onclick="viewApplications(${
                      job.jobId
                    })">View Applications</button>
                    <button onclick="deleteJob(${job.jobId})">Delete</button>
                `;
          jobsList.appendChild(jobDiv);
        });
      }

      async function createJob() {
        const jobData = {
          title: document.getElementById("jobTitle").value,
          description: document.getElementById("jobDescription").value,
          location: document.getElementById("jobLocation").value,
          company: document.getElementById("jobCompany").value,
          salaryMin:
            parseFloat(document.getElementById("jobSalaryMin").value) || null,
          salaryMax:
            parseFloat(document.getElementById("jobSalaryMax").value) || null,
        };

        try {
          const response = await fetch("/api/jobs", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            },
            body: JSON.stringify(jobData),
          });

          if (response.ok) {
            alert("Job created successfully!");
            document.getElementById("createJobForm").reset();
            await loadJobs();
          } else {
            const error = await response.text();
            alert("Failed to create job: " + error);
          }
        } catch (error) {
          alert("Failed to create job: " + error.message);
        }
      }

      function editJob(jobId) {
        const token = getJwtToken();
        if (token) {
          window.location.href = `/create-job?edit=${jobId}&token=${encodeURIComponent(
            token
          )}`;
        } else {
          window.location.href = `/create-job?edit=${jobId}`;
        }
      }

      async function deleteJob(jobId) {
        if (!confirm("Are you sure you want to delete this job?")) return;

        try {
          const response = await fetch(`/api/jobs/${jobId}`, {
            method: "DELETE",
            headers: getAuthHeaders(),
          });
          if (response.ok) {
            alert("Job deleted successfully!");
            await loadJobs();
          } else {
            alert("Failed to delete job");
          }
        } catch (error) {
          alert("Failed to delete job: " + error.message);
        }
      }

      async function viewApplications(jobId) {
        try {
          const response = await fetch(`/api/jobs/${jobId}/applications`, {
            headers: getAuthHeaders(),
          });
          if (response.ok) {
            const applications = await response.json();
            alert(`Applications for this job: ${applications.length}`);
            console.log("Applications:", applications);
          } else {
            alert("Failed to load applications");
          }
        } catch (error) {
          alert("Failed to load applications: " + error.message);
        }
      }

      async function logout() {
        removeJwtToken();
        window.location.href = "http://localhost:8083/auth/login";
      }
    </script>
  </body>
</html>
